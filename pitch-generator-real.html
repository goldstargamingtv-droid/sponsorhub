<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pitch Generator - PromoSync</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="data-service.js"></script>
    <script src="paywall-system.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2e;
            --bg-card: rgba(25, 35, 58, 0.6);
            --accent-primary: #00d9ff;
            --accent-secondary: #7b61ff;
            --text-primary: #ffffff;
            --text-secondary: #c9d1e0;
            --text-muted: #8b95ab;
            --border-color: rgba(255, 255, 255, 0.08);
            --success: #00ffa3;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .bg-gradient {
            position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; opacity: 0.15;
            background: radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            filter: blur(100px);
        }

        .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 24px 0; margin-bottom: 32px; }
        
        .logo {
            font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .back-btn {
            padding: 10px 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-secondary); text-decoration: none; font-weight: 600; transition: all 0.3s;
        }

        h1 { font-family: 'Syne', sans-serif; font-size: 42px; margin-bottom: 8px; text-align: center; }
        .subtitle { text-align: center; color: var(--text-secondary); font-size: 18px; margin-bottom: 32px; }

        .usage-banner {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(123, 97, 255, 0.1));
            border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 16px; padding: 16px 24px; margin-bottom: 32px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .usage-count { color: var(--accent-primary); font-weight: 800; }
        .upgrade-link { color: var(--accent-primary); text-decoration: underline; cursor: pointer; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 968px) { .grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-card); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 20px; padding: 32px;
        }

        .card h2 { font-family: 'Syne', sans-serif; font-size: 24px; margin-bottom: 24px; }

        .form-group { margin-bottom: 24px; }
        .form-label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }

        .pro-badge {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: white;
        }

        input, select, textarea {
            width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary);
            font-size: 14px; font-family: 'DM Sans', sans-serif;
        }

        textarea { min-height: 100px; resize: vertical; }

        .template-pills { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .template-pill {
            padding: 12px 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid var(--border-color);
            border-radius: 12px; cursor: pointer; transition: all 0.3s; font-weight: 600; position: relative;
        }

        .template-pill.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent; color: white;
        }

        .template-pill.locked {
            opacity: 0.6;
        }

        .template-pill.locked::after {
            content: 'üîí';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 14px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.03); padding: 16px;
            border-radius: 12px; text-align: center;
        }

        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--accent-primary); }

        .twitch-badge {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
            background: rgba(145, 70, 255, 0.2); border: 1px solid rgba(145, 70, 255, 0.4);
            border-radius: 8px; font-size: 12px; font-weight: 600;
        }

        .preview-card {
            background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 24px; min-height: 400px;
        }

        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);
        }

        .copy-btn, .email-btn {
            padding: 8px 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none; border-radius: 8px; color: white; font-weight: 600;
            cursor: pointer; transition: all 0.3s; font-size: 13px;
        }

        .pitch-content { color: var(--text-secondary); line-height: 1.8; }
        .pitch-subject { font-weight: 700; color: var(--text-primary); margin-bottom: 16px; font-size: 16px; }
        .pitch-body { margin-bottom: 16px; }
        .pitch-body strong { color: var(--accent-primary); }

        .placeholder {
            text-align: center; color: var(--text-muted); padding: 80px 20px; font-size: 16px;
        }

        .placeholder-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }

        .generate-btn {
            width: 100%; padding: 18px 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none; border-radius: 16px; color: white; font-size: 18px; font-weight: 800;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 30px rgba(0, 217, 255, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0, 217, 255, 0.5);
        }

        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white;
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; top: 20px; right: 20px; background: var(--success);
            color: var(--bg-primary); padding: 16px 24px; border-radius: 12px;
            font-weight: 700; z-index: 10000; animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="container">
        <header>
            <div class="logo">PromoSync</div>
            <a href="dashboard-real.html" class="back-btn">‚Üê Back to Dashboard</a>
        </header>

        <h1><span style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI Pitch Generator</span> ‚ú®</h1>
        <p class="subtitle">Create perfect sponsorship pitches in seconds</p>

        <div class="usage-banner">
            <div style="font-weight: 600;">
                Generated <span class="usage-count" id="pitchCount">0</span> of <span class="usage-count" id="pitchLimit">1</span> pitches this month
            </div>
            <a class="upgrade-link" onclick="if(window.paywall) window.paywall.showPaywall()">Upgrade for more ‚Üí</a>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Pitch Details</h2>
                
                <div class="form-group">
                    <label class="form-label">Brand Name</label>
                    <input type="text" id="brandName" placeholder="Enter brand name...">
                </div>

                <div class="form-group">
                    <label class="form-label">Your Niche</label>
                    <select id="niche">
                        <option value="gaming">Gaming</option>
                        <option value="tech">Tech</option>
                        <option value="lifestyle">Lifestyle</option>
                        <option value="fitness">Fitness</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Pitch Template</label>
                    <div class="template-pills">
                        <div class="template-pill active" data-template="professional" data-tier="free" onclick="selectTemplate('professional', 'free')">
                            Professional
                        </div>
                        <div class="template-pill locked" data-template="casual" data-tier="starter" onclick="selectTemplate('casual', 'starter')">
                            Casual
                            <span class="pro-badge" style="margin-left: 4px;">STARTER</span>
                        </div>
                        <div class="template-pill locked" data-template="creative" data-tier="pro" onclick="selectTemplate('creative', 'pro')">
                            Creative
                            <span class="pro-badge" style="margin-left: 4px;">PRO</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Notes (Optional)</label>
                    <textarea id="additionalNotes" placeholder="Add specific points..."></textarea>
                </div>
            </div>

            <div>
                <div class="card" style="margin-bottom: 24px;">
                    <h2>üìä Your Stats (Auto-filled)</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Followers</div>
                            <div class="stat-value" id="statFollowers">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Avg Viewers</div>
                            <div class="stat-value" id="statViewers">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Engagement</div>
                            <div class="stat-value" id="statEngagement">-</div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <span class="twitch-badge" id="twitchBadge" style="display: none;">
                            <span style="font-size: 16px;">üì∫</span> Stats from Twitch
                        </span>
                    </div>
                </div>

                <div class="card">
                    <h2>‚úâÔ∏è Generated Pitch Preview</h2>
                    
                    <div class="preview-card">
                        <div class="placeholder" id="placeholder">
                            <div class="placeholder-icon">üìß</div>
                            <div>Your pitch will appear here...</div>
                        </div>
                        
                        <div id="pitchPreview" style="display: none;">
                            <div class="preview-header">
                                <div style="font-weight: 700;">Email Preview</div>
                                <div>
                                    <button class="copy-btn" onclick="copyPitch()">üìã Copy</button>
                                    <button class="email-btn" onclick="sendEmail()">üìß Send <span class="pro-badge">PRO</span></button>
                                </div>
                            </div>
                            <div class="pitch-content" id="pitchContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generatePitch()">
            <span id="btnText">‚ú® Generate Pitch</span>
        </button>
    </div>

    <script>
        let selectedTemplate = 'professional';
        let currentPitch = '';
        let pitchCount = 0;
        let pitchLimit = 1;
        let userTier = 'free';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            await loadPitchCount();
        });

        async function loadUserData() {
            try {
                if (!window.authManager || !window.authManager.isAuthenticated()) {
                    document.getElementById("statFollowers").textContent = "50K";
                    document.getElementById("statViewers").textContent = "2.5K";
                    document.getElementById("statEngagement").textContent = "5.0%";
                    return;
                }

                const userId = window.authManager.user.id;
                const profile = await window.dataService.getProfile(userId);
                
                if (profile) {
                    if (profile.followers) {
                        document.getElementById("statFollowers").textContent = formatNumber(profile.followers);
                    } else {
                        document.getElementById("statFollowers").textContent = "50K";
                    }
                    
                    if (profile.avg_viewers) {
                        document.getElementById("statViewers").textContent = formatNumber(profile.avg_viewers);
                    } else {
                        document.getElementById("statViewers").textContent = "2.5K";
                    }
                    
                    if (profile.engagement_rate) {
                        document.getElementById("statEngagement").textContent = profile.engagement_rate.toFixed(1) + "%";
                    } else {
                        document.getElementById("statEngagement").textContent = "5.0%";
                    }
                    
                    if (profile.content_niche) {
                        document.getElementById("niche").value = profile.content_niche;
                    }
                    
                    if (profile.twitch_username) {
                        document.getElementById("twitchBadge").style.display = "inline-flex";
                    }
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                document.getElementById("statFollowers").textContent = "50K";
                document.getElementById("statViewers").textContent = "2.5K";
                document.getElementById("statEngagement").textContent = "5.0%";
            }
        }

        async function loadPitchCount() {
            try {
                // Get tier from paywall
                userTier = window.paywall?.currentTier || 'free';
                
                if (userTier === 'free') pitchLimit = 1;
                else if (userTier === 'starter') pitchLimit = 10;
                else if (userTier === 'pro') pitchLimit = Infinity;

                // Load count from localStorage (persists across refreshes)
                const stored = localStorage.getItem('pitchCount_' + getCurrentMonth());
                pitchCount = stored ? parseInt(stored) : 0;
                
                updateUsageDisplay();
            } catch (error) {
                console.error('Error loading pitch count:', error);
            }
        }

        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}`;
        }

        function updateUsageDisplay() {
            document.getElementById('pitchCount').textContent = pitchCount;
            document.getElementById('pitchLimit').textContent = pitchLimit === Infinity ? '‚àû' : pitchLimit;
        }

        function selectTemplate(template, requiredTier) {
            // Check tier access
            const tierLevels = { free: 0, starter: 1, pro: 2 };
            const userLevel = tierLevels[userTier];
            const requiredLevel = tierLevels[requiredTier];
            
            if (userLevel < requiredLevel) {
                if (window.paywall) window.paywall.showPaywall();
                return;
            }
            
            selectedTemplate = template;
            document.querySelectorAll('.template-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-template="${template}"]`).classList.add('active');
        }

        async function generatePitch() {
            const brandName = document.getElementById('brandName').value.trim();
            if (!brandName) { alert('Please enter a brand name'); return; }
            if (pitchCount >= pitchLimit) { if (window.paywall) window.paywall.showPaywall(); return; }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.innerHTML = '<div class="spinner"></div> Generating...';

            try {
                await new Promise(r => setTimeout(r, 2000));
                
                const followers = document.getElementById('statFollowers').textContent;
                const viewers = document.getElementById('statViewers').textContent;
                const engagement = document.getElementById('statEngagement').textContent;
                const notes = document.getElementById('additionalNotes').value;
                
                const pitch = generatePitchText(brandName, selectedTemplate, followers, viewers, engagement, notes);

                displayPitch(pitch);
                
                // Save count
                pitchCount++;
                localStorage.setItem('pitchCount_' + getCurrentMonth(), pitchCount.toString());
                updateUsageDisplay();
                
                showToast('‚ú® Pitch ready!');
                if (typeof confetti !== 'undefined') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } finally {
                btn.disabled = false;
                btnText.innerHTML = '‚ú® Generate Pitch';
            }
        }

        function generatePitchText(brandName, template, followers, viewers, engagement, notes) {
            if (template === 'professional') {
                return `Subject: Partnership Opportunity with ${brandName}

Dear ${brandName} Team,

I am writing to propose a strategic partnership between ${brandName} and my content platform. With <strong>${followers} followers</strong> and an average of <strong>${viewers} viewers</strong> per stream, I have cultivated a highly engaged community that aligns with your brand values.

<strong>Performance Metrics:</strong>
My content consistently achieves a <strong>${engagement} engagement rate</strong>, significantly exceeding industry benchmarks. This demonstrates the quality of my audience and their receptiveness to brand partnerships.

<strong>Proposed Collaboration:</strong>
‚Ä¢ Dedicated sponsored content featuring ${brandName} products
‚Ä¢ In-depth product demonstrations and reviews
‚Ä¢ Exclusive promotional codes for my audience
‚Ä¢ Cross-platform social media amplification

${notes ? `<strong>Additional Value:</strong>\n${notes}\n\n` : ''}I am confident that a partnership between ${brandName} and my platform would deliver measurable results and authentic audience engagement.

I would welcome the opportunity to discuss this proposal further at your convenience.

Sincerely,
[Your Name]
[Your Channel]`;
            } else if (template === 'casual') {
                return `Subject: Hey ${brandName}! Let's Work Together üéÆ

Hey ${brandName} Team!

I've been a huge fan of your brand and I think we'd be an awesome fit for a collab! My community is pretty engaged (we're talking <strong>${followers} followers</strong> and <strong>${viewers} viewers</strong> per stream with a solid <strong>${engagement} engagement rate</strong>).

<strong>Here's what I'm thinking:</strong>
We could do some really cool content together - product showcases, honest reviews, maybe some fun challenges featuring your stuff. My audience trusts my recommendations and they're always asking what gear I use.

${notes ? `Also: ${notes}\n\n` : ''}What do you say? Want to chat about making something awesome together?

Looking forward to hearing from you!
[Your Name]
[Your Channel]`;
            } else { // creative
                return `Subject: üöÄ ${brandName} x [Your Name] = Magic ‚ú®

Dear ${brandName} Visionaries,

Imagine this: <strong>${followers} passionate fans</strong>, <strong>${viewers} live viewers</strong> per show, and a <strong>${engagement} engagement rate</strong> that makes marketing teams weep with joy. That's what I bring to the table.

<strong>The Opportunity:</strong>
This isn't just another sponsorship pitch. This is your chance to tap into an audience that doesn't just watch‚Äîthey <em>participate</em>, they <em>share</em>, they <em>buy</em>.

<strong>What We'll Create:</strong>
üé¨ Cinematic product showcases that go viral
üí° Authentic storytelling that converts
üî• Content so good, your competitors will wish they got here first

${notes ? `<strong>The Secret Sauce:</strong>\n${notes}\n\n` : ''}${brandName}, you don't need another influencer. You need a <em>partner</em> who understands your vision and can amplify it to the right audience.

Let's create something legendary.

[Your Name]
Creator. Storyteller. Your Next Best Investment.`;
            }
        }

        function displayPitch(pitch) {
            currentPitch = pitch;
            const html = pitch.split('\n').filter(l => l.trim()).map(line => {
                if (line.startsWith('Subject:')) return `<div class="pitch-subject">${line}</div>`;
                return `<p class="pitch-body">${line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/<em>(.+?)<\/em>/g, '<em style="color: var(--accent-secondary);">$1</em>')}</p>`;
            }).join('');
            
            document.getElementById('pitchContent').innerHTML = html;
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('pitchPreview').style.display = 'block';
        }

        function copyPitch() {
            const plainText = currentPitch.replace(/<strong>|<\/strong>/g, '').replace(/<em>|<\/em>/g, '');
            navigator.clipboard.writeText(plainText);
            showToast('üìã Copied!');
        }

        function sendEmail() {
            if (window.paywall) window.paywall.showPaywall();
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
