<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pitch Generator - PromoSync</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="data-service.js"></script>
    <script src="paywall-system.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2e;
            --bg-card: rgba(25, 35, 58, 0.6);
            --accent-primary: #00d9ff;
            --accent-secondary: #7b61ff;
            --text-primary: #ffffff;
            --text-secondary: #c9d1e0;
            --text-muted: #8b95ab;
            --border-color: rgba(255, 255, 255, 0.08);
            --success: #00ffa3;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .bg-gradient {
            position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; opacity: 0.15;
            background: radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            filter: blur(100px);
        }

        .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 24px 0; margin-bottom: 32px; }
        
        .logo {
            font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .back-btn {
            padding: 10px 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-secondary); text-decoration: none; font-weight: 600; transition: all 0.3s;
        }

        h1 { font-family: 'Syne', sans-serif; font-size: 42px; margin-bottom: 8px; text-align: center; }
        .subtitle { text-align: center; color: var(--text-secondary); font-size: 18px; margin-bottom: 32px; }

        .usage-banner {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(123, 97, 255, 0.1));
            border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 16px; padding: 16px 24px; margin-bottom: 32px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .usage-count { color: var(--accent-primary); font-weight: 800; }
        .upgrade-link { color: var(--accent-primary); text-decoration: underline; cursor: pointer; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 968px) { .grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-card); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 20px; padding: 32px;
        }

        .card h2 { font-family: 'Syne', sans-serif; font-size: 24px; margin-bottom: 24px; }

        .form-group { margin-bottom: 24px; }
        .form-label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }

        .pro-badge {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: white;
        }

        input, select, textarea {
            width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary);
            font-size: 14px; font-family: 'DM Sans', sans-serif;
        }

        textarea { min-height: 100px; resize: vertical; }

        .template-pills { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .template-pill {
            padding: 12px 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid var(--border-color);
            border-radius: 12px; cursor: pointer; transition: all 0.3s; font-weight: 600;
        }

        .template-pill.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent; color: white;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.03); padding: 16px;
            border-radius: 12px; text-align: center;
        }

        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--accent-primary); }

        .twitch-badge {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
            background: rgba(145, 70, 255, 0.2); border: 1px solid rgba(145, 70, 255, 0.4);
            border-radius: 8px; font-size: 12px; font-weight: 600;
        }

        .preview-card {
            background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 24px; min-height: 400px;
        }

        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);
        }

        .copy-btn, .email-btn {
            padding: 8px 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none; border-radius: 8px; color: white; font-weight: 600;
            cursor: pointer; transition: all 0.3s; font-size: 13px;
        }

        .pitch-content { color: var(--text-secondary); line-height: 1.8; }
        .pitch-subject { font-weight: 700; color: var(--text-primary); margin-bottom: 16px; font-size: 16px; }
        .pitch-body { margin-bottom: 16px; }
        .pitch-body strong { color: var(--accent-primary); }

        .placeholder {
            text-align: center; color: var(--text-muted); padding: 80px 20px; font-size: 16px;
        }

        .placeholder-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }

        .generate-btn {
            width: 100%; padding: 18px 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none; border-radius: 16px; color: white; font-size: 18px; font-weight: 800;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 30px rgba(0, 217, 255, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0, 217, 255, 0.5);
        }

        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white;
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; top: 20px; right: 20px; background: var(--success);
            color: var(--bg-primary); padding: 16px 24px; border-radius: 12px;
            font-weight: 700; z-index: 10000; animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="container">
        <header>
            <div class="logo">PromoSync</div>
            <a href="dashboard-real.html" class="back-btn">‚Üê Back to Dashboard</a>
        </header>

        <h1><span style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI Pitch Generator</span> ‚ú®</h1>
        <p class="subtitle">Create perfect sponsorship pitches in seconds</p>

        <div class="usage-banner">
            <div style="font-weight: 600;">
                Generated <span class="usage-count" id="pitchCount">0</span> of <span class="usage-count" id="pitchLimit">1</span> pitches this month
            </div>
            <a class="upgrade-link" onclick="if(window.paywall) window.paywall.showPaywall()">Upgrade for more ‚Üí</a>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Pitch Details</h2>
                
                <div class="form-group">
                    <label class="form-label">Brand Name</label>
                    <input type="text" id="brandName" placeholder="Enter brand name...">
                </div>

                <div class="form-group">
                    <label class="form-label">Your Niche</label>
                    <select id="niche">
                        <option value="gaming">Gaming</option>
                        <option value="tech">Tech</option>
                        <option value="lifestyle">Lifestyle</option>
                        <option value="fitness">Fitness</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Pitch Template</label>
                    <div class="template-pills">
                        <div class="template-pill active" data-template="professional" onclick="selectTemplate('professional')">Professional</div>
                        <div class="template-pill" data-template="casual" onclick="selectTemplate('casual')">Casual <span class="pro-badge">STARTER</span></div>
                        <div class="template-pill" data-template="creative" onclick="selectTemplate('creative')">Creative <span class="pro-badge">PRO</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Notes (Optional)</label>
                    <textarea id="additionalNotes" placeholder="Add specific points..."></textarea>
                </div>
            </div>

            <div>
                <div class="card" style="margin-bottom: 24px;">
                    <h2>üìä Your Stats (Auto-filled)</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Followers</div>
                            <div class="stat-value" id="statFollowers">50K</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Avg Viewers</div>
                            <div class="stat-value" id="statViewers">2.5K</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Engagement</div>
                            <div class="stat-value" id="statEngagement">5.0%</div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <span class="twitch-badge" id="statsBadge"><span style="font-size: 16px;">üì∫</span> Stats from Twitch</span>
                    </div>
                </div>

                <div class="card">
                    <h2>‚úâÔ∏è Generated Pitch Preview</h2>
                    
                    <!-- Locked Preview for Free Users -->
                    <div class="preview-card" id="previewLocked" style="position: relative; min-height: 400px; display: none;">
                        <div style="filter: blur(3px); pointer-events: none; opacity: 0.4;">
                            <div class="preview-header">
                                <div style="font-weight: 700;">Email Preview</div>
                            </div>
                            <div class="pitch-content">
                                <p>Subject: Partnership Opportunity</p>
                                <p>Dear Brand Team,</p>
                                <p>I'm reaching out to discuss a potential partnership...</p>
                            </div>
                        </div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(10, 14, 26, 0.95); padding: 32px; border-radius: 16px; z-index: 10; border: 2px dashed rgba(0, 217, 255, 0.3);">
                            <span style="font-size: 48px;">üîí</span>
                            <p style="font-weight: 700; margin: 16px 0 8px 0; font-size: 20px;">Unlock Pitch Preview</p>
                            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">See generated pitches instantly</p>
                            <button class="btn btn-primary" style="width: auto; padding: 12px 32px; margin: 0 auto; display: block; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer;" onclick="if(window.paywall) window.paywall.showPaywall('starter')">Upgrade to Starter</button>
                        </div>
                    </div>
                    
                    <!-- Unlocked Preview for Pro Users -->
                    <div class="preview-card" id="previewUnlocked">
                        <div class="placeholder" id="placeholder">
                            <div class="placeholder-icon">üìß</div>
                            <div>Your pitch will appear here...</div>
                        </div>
                        
                        <div id="pitchPreview" style="display: none;">
                            <div class="preview-header">
                                <div style="font-weight: 700;">Email Preview</div>
                                <div>
                                    <button class="copy-btn" onclick="copyPitch()">üìã Copy</button>
                                    <button class="email-btn" onclick="sendEmail()">üìß Send <span class="pro-badge">PRO</span></button>
                                </div>
                            </div>
                            <div class="pitch-content" id="pitchContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generatePitch()">
            <span id="btnText">‚ú® Generate Pitch</span>
        </button>
    </div>

    <script>
        let selectedTemplate = 'professional';
        let currentPitch = '';
        let pitchCount = 0;
        let pitchLimit = 1;

        function selectTemplate(template) {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userTier = user.subscription_tier || 'free';
            
            // Check tier access
            if (template === 'casual' && userTier === 'free') {
                if (window.paywall) window.paywall.showPaywall('starter');
                return;
            }
            if (template === 'creative' && (userTier === 'free' || userTier === 'starter')) {
                if (window.paywall) window.paywall.showPaywall('pro');
                return;
            }
            
            selectedTemplate = template;
            document.querySelectorAll('.template-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-template="${template}"]`).classList.add('active');
        }
        
        // Check tiers on page load
        function initializeTiers() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userTier = user.subscription_tier || 'free';
            
            // Show/hide preview based on tier (Starter or Pro unlocks)
            const previewLocked = document.getElementById('previewLocked');
            const previewUnlocked = document.getElementById('previewUnlocked');
            
            if (userTier === 'starter' || userTier === 'pro') {
                previewLocked.style.display = 'none';
                previewUnlocked.style.display = 'block';
            } else {
                previewLocked.style.display = 'block';
                previewUnlocked.style.display = 'none';
            }
            
            // Update stats badge based on platform
            const statsBadge = document.getElementById('statsBadge');
            if (user.platform === 'youtube') {
                statsBadge.innerHTML = '<span style="font-size: 16px;">‚ñ∂Ô∏è</span> Stats from YouTube';
                statsBadge.style.background = 'linear-gradient(135deg, #ff0000, #c4302b)';
            } else {
                statsBadge.innerHTML = '<span style="font-size: 16px;">üì∫</span> Stats from Twitch';
                statsBadge.style.background = 'linear-gradient(135deg, #9146ff, #6441a5)';
            }
        }
        
        // Call on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeTiers();
            loadPitchCount();
        });

        async function generatePitch() {
            const brandName = document.getElementById('brandName').value.trim();
            if (!brandName) { alert('Please enter a brand name'); return; }
            if (pitchCount >= pitchLimit) { if (window.paywall) window.paywall.showPaywall(); return; }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.innerHTML = '<div class="spinner"></div> Generating...';

            try {
                const niche = document.getElementById('niche').value;
                const additionalNotes = document.getElementById('additionalNotes').value;
                const followers = document.getElementById('statFollowers').textContent;
                const viewers = document.getElementById('statViewers').textContent;
                const engagement = document.getElementById('statEngagement').textContent;
                
                // Build prompt based on template
                let stylePrompt = '';
                if (selectedTemplate === 'professional') {
                    stylePrompt = 'Write in a professional, business-like tone.';
                } else if (selectedTemplate === 'casual') {
                    stylePrompt = 'Write in a friendly, casual tone that feels personal.';
                } else if (selectedTemplate === 'creative') {
                    stylePrompt = 'Write in a creative, attention-grabbing tone with unique angles.';
                }
                
                const prompt = `Create a sponsorship pitch email for ${brandName}. 

Creator Stats:
- Followers: ${followers}
- Average Viewers: ${viewers}
- Engagement Rate: ${engagement}
- Niche: ${niche}

${additionalNotes ? `Additional Info: ${additionalNotes}` : ''}

${stylePrompt}

Include:
1. Subject line
2. Introduction explaining the partnership opportunity
3. Key statistics about audience reach
4. Why the partnership makes sense
5. Collaboration ideas
6. Professional closing

Format as a complete email ready to send.`;

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });
                
                const data = await response.json();
                const pitch = data.content[0].text;

                displayPitch(pitch);
                pitchCount++;
                document.getElementById('pitchCount').textContent = pitchCount;
                
                // Save pitch count to database
                await savePitchCount();
                
                showToast('‚ú® Pitch ready!');
                if (typeof confetti !== 'undefined') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } catch (error) {
                console.error('Generation error:', error);
                alert('Error generating pitch. Please try again.');
            } finally {
                btn.disabled = false;
                btnText.innerHTML = '‚ú® Generate Pitch';
            }
        }
        
        async function savePitchCount() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                
                await supabase
                    .from('pitch_usage')
                    .upsert({
                        user_id: user.id,
                        month: currentMonth,
                        count: pitchCount
                    }, { onConflict: 'user_id,month' });
            } catch (error) {
                console.error('Error saving pitch count:', error);
            }
        }
        
        async function loadPitchCount() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                
                const { data } = await supabase
                    .from('pitch_usage')
                    .select('count')
                    .eq('user_id', user.id)
                    .eq('month', currentMonth)
                    .single();
                
                if (data) {
                    pitchCount = data.count;
                    document.getElementById('pitchCount').textContent = pitchCount;
                }
            } catch (error) {
                console.log('No existing pitch count');
            }
        }

        function displayPitch(pitch) {
            currentPitch = pitch;
            const html = pitch.split('\n').filter(l => l.trim()).map(line => {
                if (line.startsWith('Subject:')) return `<div class="pitch-subject">${line}</div>`;
                return `<p class="pitch-body">${line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</p>`;
            }).join('');
            
            // Check if user is Starter or Pro to show preview
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userTier = user.subscription_tier || 'free';
            
            if (userTier === 'starter' || userTier === 'pro') {
                document.getElementById('pitchContent').innerHTML = html;
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('pitchPreview').style.display = 'block';
            }
            
            // Ask if user wants to download
            if (confirm('Would you like to download this pitch as a text file?')) {
                const cleanPitch = pitch.replace(/<\/?strong>/g, '');
                const blob = new Blob([cleanPitch], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${document.getElementById('brandName').value}_Pitch.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function copyPitch() {
            navigator.clipboard.writeText(currentPitch);
            showToast('üìã Copied!');
        }

        function sendEmail() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userTier = user.subscription_tier || 'free';
            
            if (userTier !== 'pro') {
                if (window.paywall) window.paywall.showPaywall('pro');
                return;
            }
            
            // For Pro users, open mailto with the pitch
            const brandName = document.getElementById('brandName').value;
            const subject = `Partnership Opportunity with ${user.username || 'Creator'}`;
            const body = currentPitch.replace(/<\/?strong>/g, '').replace(/<br>/g, '\n');
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            showToast('üìß Email client opened!');
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
